layui.define(["form","table"],function(y){layui.link(layui.cache.base+"/opTable/opTable.css",function(){},"opTable");layui.$("body").append('<script type="text/javascript" src="'+layui.cache.base+'/opTable/Sortable.min.js" charset="utf-8"><\/script>');var d=layui.$,w=layui.table,v=1.4,i="opTable",e="on",a="off",h="status",j=0,q=1,b=2,o=3,u="-1",p="0",r={index:layui.opTable?(layui.opTable.index+10000):0,set:function(z){var A=this;A.config=d.extend({},A.config,z);return A}},m={},s={},n={},g=true,f={key:i,getVal:function(z,A){return layui.data(this.key)[z]||A},setVal:function(z,A){layui.data(this.key,{key:z,value:A})},getTableKeyId:function(z){return window.location.pathname+z}},x=function(z,A){return z.replace("#","").replace(".","")+(A?"opTable-i-table-open":"")},c=function(z){return x(z,true)+"-all"},k=function(B,A,z){return B?"":'<i class="opTable-i-table-open '+c(A)+' " '+h+'="off"  title="(展开|关闭)全部" '+z+"></i>"},l=function(){var A=this,z=A.config;return{reload:function(B){B=B||{};A.config=d.extend(A.config,B);B.page=B.page===false?false:B.page||{};if(B.page){A.config.page={};var C=A.config.table.config.page||{};A.config.page.curr=B.page.curr||C.curr}if(!B.limit){A.config.limit=A.config.table.config.limit}A.render();return this},config:z,openAll:function(B){if(this.isOpenAll()){B&&B();return this}var C=A.config.openType;A.config.openType=b;d("."+x(A.config.elem,true)).parent().click();A.config.openType=C;d("."+c(A.config.elem)).addClass("opTable-open-dow").removeClass("opTable-open-up").attr(h,e);A.config.onOpenAll&&A.config.onOpenAll();B&&B();return this},closeAll:function(){if(!this.isOpenAll()){return this}var B=A.config.openType;A.config.openType=o;d("."+x(A.config.elem,true)).parent().click();A.config.openType=B;d("."+c(A.config.elem)).addClass("opTable-open-up").removeClass("opTable-open-dow").attr(h,a);A.config.onCloseAll&&A.config.onCloseAll();return this},openIndex:function(C){var D=d("."+x(A.config.elem,true)).eq(C);if(D.length<=0){return false}var B=D.attr(h);if(B===e){return true}D.click();return true},closeIndex:function(C){var D=d("."+x(A.config.elem,true)).eq(C);if(D.length<=0){return false}var B=D.attr(h);if(B===a){return true}D.click();return true},toggleOpenIndex:function(B){var C=d("."+x(A.config.elem,true)).eq(B);if(C.length<=0){return false}C.parent().click();return true},isOpenAll:function(){var B=d("."+x(A.config.elem,true));var C=[];B.each(function(D){if(B.eq(D).hasClass("opTable-open-dow")){C.push(true)}});return B.length===C.length}}},t=function(z){var A=this;A.index=++r.index;A.config=d.extend({},A.config,r.config,z);A.render();return this};t.prototype.config={openVisible:true,isOpenAllClick:true,openType:j,opOrientation:"v",openColumnIndex:0,isAloneColumn:true,openIcon:{},table:null,slideDownTime:200,slideUpTime:100};t.prototype.render=function(){var E=this,C=E.config,Q=C.cols[0],K=C.openCols||[],L=C.openNetwork||null,F=C.openTable||null,O=[],J=[],z=[];C.layuiDone=C.done||C.layuiDone;var H=C.elem.replace("#","").replace(".","");Q.forEach(function(S,R){if(S.isOpenCol){if(C.isAloneColumn){Q.splice(R,1)}else{S.title=S.opDefTitle||S.title}}if(S.opHelp){S.title=S.title.indexOf("opTable-span-help")===-1?S.title+'<span class="opTable-span-help" single="'+H+S.field+'"></span>':S.title;s[H+S.field]=S.opHelp}});C.openColumnIndex=C.openColumnIndex>Q.length?Q.length:C.openColumnIndex;delete C.done;var M=function(){var R=C.openIcon[u];if(R){return"style='background: url("+R+") 0 0 no-repeat'"}return""},A=function(){var R=C.openIcon[p];if(R){return"style='background: url("+R+") 0 0 no-repeat'"}return""},B=function(R){var S=C.openIcon[R+""];if(S){return"style='background: url("+S+") 0 0 no-repeat'"}return A};if(C.openVisible){if(C.isAloneColumn){Q.splice(C.openColumnIndex,0,{width:50,isOpenCol:true,title:k(!C.isOpenAllClick,C.elem,M()),templet:function(R){var S=x(C.elem,false);m[S]=m[S]||{};m[S][R.LAY_INDEX]=R;return"<i class='opTable-i-table-open "+S+"opTable-i-table-open' "+h+"='off'  data='"+R.LAY_INDEX+" ' elem='"+S+"' title='展开' "+(B()())+"></i>"}})}else{var D=Q[C.openColumnIndex];delete D.edit;D.opDefTitle=D.title;D.isOpenCol=true;D.title=k(D.sort,C.elem,M())+("<span class='opTable-span-seize'></span>")+D.title;D.templet=function(R){var S=x(C.elem,false);m[S]=m[S]||{};m[S][R.LAY_INDEX]=R;return("<i class='opTable-i-table-open "+S+"opTable-i-table-open' "+h+"='off'  data='"+R.LAY_INDEX+" ' elem='"+S+"' title='展开' "+B(R.LAY_INDEX)+"></i>")+("<span class='opTable-span-seize'></span>")+(D.onDraw?D.onDraw(R):R[D.field])}}}var G=f.getVal(f.getTableKeyId(C.id),null);if(G){Q.forEach(function(S,R){if(Q[0].isOpenCol){R!==0&&O.push(S)}else{O.push(S)}});C.openCols.forEach(function(S,R){S.isOpenColsItem=true;O.push(S)});O.forEach(function(S){if(S.title){var R=G[S.title];if(!R){S.isOpenColsItem?z.push(S):J.push(S);return}if(R.isShow){S.opCacheSort=R.sort;if(S.isOpenColsItem&&S.onDraw){S.templet=S.onDraw;delete S.onDraw}J.push(S)}else{S.opCacheSort=R.sort;if(!S.isOpenColsItem&&S.templet){S.onDraw=S.templet;delete S.templet}z.push(S)}}else{S.isOpenColsItem?z.push(S):J.push(S)}});J.sort(function(S,R){return parseInt(S.opCacheSort)-parseInt(R.opCacheSort)});z.sort(function(S,R){return parseInt(S.opCacheSort)-parseInt(R.opCacheSort)});if(Q[0].isOpenCol){J.splice(C.openColumnIndex,0,Q[0])}C.cols[0]=J;C.openCols=z}C.table=w.render(d.extend({done:function(R,T,S){N();C.layuiDone&&C.layuiDone(R,T,S)}},C));n[H]=C;function N(){I();if(!C.openVisible){return}var R=d("."+x(C.elem,true)).parent().unbind("click").click(function(aj){layui.stope(aj);var ac=d(this).children(),ah=this,T=ac.attr("elem"),al=parseInt(ac.attr("data")),ab=m[T][al],ag=ac.attr(h)==="on",ae=ac.parent().parent().parent().parent().find(".opTable-open-dow"),X=ac.parent().parent().parent().parent().find(".opTable-open-td"),am=T+"-opTable-open-item-div",W=n[T].config||n[T],af=W.openCols,ao=W.cols[0],an;function ak(){W.onClose&&W.onClose(ab,al)}if(W.openType===o){ae.addClass("opTable-open-up").removeClass("opTable-open-dow").attr(h,a);X.slideUp(W.slideUpTime,function(){X.remove()});ak();return}if(W.openType===b){ae.addClass("opTable-open-dow").removeClass("opTable-open-up").attr(h,e);if(ag){ah.addTR.remove()}}else{if(W.openType===j){var S=ae.attr(h),V=(ac.attr("data")===ae.attr("data"));ae.addClass("opTable-open-up").removeClass("opTable-open-dow").attr(h,a);if(S===e&&V){X.slideUp(W.slideUpTime,function(){X.remove();ak()});return}else{ac.attr(h,a);X.remove()}}else{if(W.openType===q){if(ag){ac.removeClass("opTable-open-dow");ac.attr(h,a);this.addTR.find("div").eq(0).slideUp(W.slideUpTime,function(){ah.addTR.remove();ak()});return}}}}this.addTR=d(["<tr><td class='opTable-open-td'  colspan='"+(ao.length+(W.isAloneColumn?1:0))+"'>","<div style='margin-left: 50px;display: none'></div>","</td></tr>"].join(""));var U=ah.addTR.children().children();ac.parent().parent().parent().after(this.addTR);var ad=[];if(L){Z()}else{if(F){if(typeof F!=="function"){throw"OPTable: openTable attribute is function "}var aa=F(ab);aa.layuiDone=aa.done;aa.done=function(ap,ar,aq){d(".opTable-open-td tr").hover(function(at){layui.stope(at)});aa.layuiDone&&aa.layuiDone(ap,ar,aq)};an=aa.elem.replace("#","").replace(".","");U.empty().append("<table id='"+an+"' lay-filter='"+an+"'></table>").css({padding:"0 10px 0 50px","margin-left":"0",width:ah.addTR.width()}).fadeIn(400);X.css("cssText","background-color:#FCFCFC!important");n[an]=layui.opTable.render(aa)}else{af.forEach(function(ap){Y(ap,ab)});U.append(ad.join(""));this.addTR.find("div").slideDown(W.slideDownTime);ai(ab)}}function Z(){U.empty().append('<div class="opTable-network-message" ><i class="layui-icon layui-icon-loading layui-icon layui-anim layui-anim-rotate layui-anim-loop" data-anim="layui-anim-rotate layui-anim-loop"></i></div>');ah.addTR.find("div").slideDown(W.slideDownTime);L.onNetwork(ab,function(ap){L.openCols.forEach(function(ar,aq){Y(ar,ap)});U.empty().append(ad.join(""));ai(ap)},function(ap){U.empty().append("<div class='opTable-reload opTable-network-message' style='text-align: center;margin-top: 20px'>"+(ap||"没有数据")+"</div>");d(".opTable-reload").unbind().click(function(aq){Z()})})}function Y(aq,ap){if(aq.opHelp){aq.title=aq.title.indexOf("opTable-span-help")===-1?aq.title+'<span class="opTable-span-help" single="'+H+aq.field+'"></span>':aq.title;s[H+aq.field]=aq.opHelp}if(aq.templet){ad.push("<div id='"+aq.field+"' class='opTable-open-item-div "+am+"' index='"+al+"' opOrientation='"+W.opOrientation+"'>");ad.push(aq.templet(ap));ad.push("</div>")}else{if(aq.type&&aq.type==="select"){var at=["<div id='"+aq.field+"' class='opTable-open-item-div "+am+"' index='"+al+"' opOrientation='"+W.opOrientation+"' >"];at.push("<span style='color: #99a9bf'>"+aq.title+"：</span>");at.push("<div class='layui-input-inline'><select  lay-filter='"+aq.field+"'>");aq.items(ap).forEach(function(au){at.push("<option value='"+au.id+"' ");at.push(au.isSelect?" selected='selected' ":"");at.push(" >"+au.value+"</option>")});at.push("</select></div>");at.push("</div>");ad.push(at.join(""));setTimeout(function(){layui.form.render();layui.form.on("select("+aq.field+")",function(av){if(W.onEdit&&aq.isEdit&&aq.isEdit(av,ap)){var au={};au.value=av.value;au.field=aq.field;ap[aq.field]=av.value;au.data=JSON.parse(JSON.stringify(ap));W.onEdit(au)}})},20)}else{var ar=aq.onDraw?aq.onDraw(ap):ap[aq.field];ar=ar||"";ad.push("<div id='"+aq.field+"' class='opTable-open-item-div "+am+"' index='"+al+"' opOrientation='"+W.opOrientation+"'>");ad.push("<span class='opTable-item-title'>"+aq.title+"：</span>");ad.push((aq.edit?("<input  class='opTable-exp-value opTable-exp-value-edit' autocomplete='off' name='"+aq.field+"' value='"+ar+"'/>"):("<span class='opTable-exp-value' >"+ar+"</span>")));ad.push("</div>")}}}function ai(ap){d(".opTable-exp-value-edit").unbind("blur").blur(function(){var at=d(this),aq=at.attr("name"),au=at.val();if(W.onEdit&&ap[aq]+""!==au){var ar={};ar.value=at.val();ar.field=at.attr("name");ap[aq]=au;ar.data=ap;W.onEdit(ar)}}).keypress(function(aq){aq.which===13&&d(this).blur()})}if(W.onItemClick){d("."+am).unbind("click").click(function(aq){var ap=d(this).attr("id");var ar=m[x(W.elem,false)][d(this).attr("index")];W.onItemClick({lineData:ar,field:ap,value:ar[ap],div:d(this),e:aq})})}ac.addClass("opTable-open-dow");ac.attr(h,e);W.onInitSuccess&&W.onInitSuccess(ab,al,this.addTR,n[an]);setTimeout(function(){W.onOpen&&W.onOpen(ab,al,ac.addTR,n[an]);I()},W.slideDownTime)});R.parents(".layui-table-view").find('.layui-table-tool>.layui-table-tool-self > div[lay-event="LAYTABLE_COLS"]').eq(0).unbind("click").attr("elem",H).on("click",function(){var S=d(this);setTimeout(function(){var V=S.find("ul"),U=n[S.attr("elem")];if(!U.openCols){return}var T=[];U.cols[0].forEach(function(W){if(W.title&&W.toolbar){T.push("<li>");T.push('<input type="checkbox" name="'+W.title+'" title="'+W.title+'" checked="checked" lay-skin="primary"/>');T.push("</li>")}});U.openCols.forEach(function(W){if(W.title){var X=d("<div>"+W.title+"</div>").text();T.push("<li>");T.push('<i class="opTable-i-table-open"></i>');T.push("<div style='display: inline-block;margin-left: 12px'>");T.push('<input type="checkbox" name="'+X+'" title="'+X+'" lay-skin="primary"/>');T.push("</div>");T.push("</li>")}});V.append(T.join(""));V.append('<div class="op-edit-field-btn"><button type="button" class="layui-btn layui-btn-xs layui-btn-warm">重置</button><button type="button" class="layui-btn layui-btn-xs layui-btn-normal">保存</button></div>');layui.form.render("checkbox");Sortable.create(V[0]);V.find(".op-edit-field-btn button").unbind("click").click(function(){var W=f.getTableKeyId(U.id);if(d(this).text()==="重置"){f.setVal(W,[]);layer.msg("成功，刷新生效。")}else{var X=V.find("input");var Y={};X.each(function(Z){var aa=X.eq(Z);Y[aa.attr("title")]={sort:Z,isShow:aa.parent().find(".layui-form-checked").length>0}});f.setVal(W,Y);layer.msg("成功，刷新生效。")}})},40)});d("."+c(C.elem)).parent().parent().unbind("click").click(function(){if(!C.isOpenAllClick){return}var S=d(this).find("i").eq(0),T=S.attr(h);if(T===e){S.addClass("opTable-open-up").removeClass("opTable-open-dow").attr(h,a);C.thisIns.closeAll()}else{S.addClass("opTable-open-dow").removeClass("opTable-open-up").attr(h,e);C.thisIns.openAll()}})}function I(){d(".opTable-span-help").unbind("click").click(function(U){layui.stope(U);var T=d(this);var S=s[T.attr("single")];var R=layer.tips(S.text+"<span class='op-span-help-close'>关闭</span>",T.parent(),d.extend({tips:3,time:40000,success:function(){d(".op-span-help-close").click(function(){layer.close(R)})}},S.tipOpt))})}var P=d(C.elem).attr("lay-filter");w.on("sort("+P+")",function(R){C.onSort&&C.onSort(R);N()});layui.table.on("edit("+P+")",function(R){if(!g){return}g=false;C.onEdit&&C.onEdit(R);setTimeout(function(){g=true},100)})};r.render=function(A){var z=new t(A);var B=l.call(z);z.config.thisIns=B;return B};r.openTableVersion=v;r.childTableObj=n;y(i,r)});